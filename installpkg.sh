#!/usr/bin/env bash
set -euo pipefail

# ==== ParamÃ¨tres ====
GIT_URL="https://github.com/votre-org/vitte.git"
GIT_REF="main"
PKG_ID="com.vitte.lang"
VERSION="1.0.0"
FEATURES="${FEATURES:-}"
PREFIX="${PREFIX:-/usr/local}"
TARGETS="${TARGETS:-aarch64-apple-darwin}"
PROFILE="${PROFILE:-release}"

ROOT="$(pwd)"
BUILD="dist/pkg_net"
PAYLOAD="$BUILD/payload"
SCRIPTS="$BUILD/scripts"
PKG_OUT="$ROOT/vitte-installer-${VERSION}.pkg"

rm -rf "$BUILD"; mkdir -p "$PAYLOAD" "$SCRIPTS"

cat > "$SCRIPTS/preinstall" <<'PRE'
#!/usr/bin/env bash
set -euo pipefail
echo "[vitte] PrÃ©-installationâ€¦"
exit 0
PRE
chmod +x "$SCRIPTS/preinstall"

cat > "$SCRIPTS/postinstall" <<'POST'
#!/usr/bin/env bash
set -euo pipefail

# Detect interactive TTY (installer usually runs headless)
INTERACTIVE=0
if [ -t 1 ]; then INTERACTIVE=1; fi

if [ "$INTERACTIVE" -eq 1 ]; then
  color(){ tput setaf "$1"; }
  reset(){ tput sgr0; }
else
  color(){ :; }
  reset(){ :; }
fi

# â”€â”€ Fonctions utilitaires â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
log(){ echo "$(color 6)[vitte]$(reset) $*"; }
fail(){ echo "$(color 1)[ERREUR]$(reset) $*" >&2; exit 1; }
need(){ command -v "$1" >/dev/null 2>&1 || fail "DÃ©pendance manquante: $1"; }

# â”€â”€ Progression simple â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
progress() {
  local current=$1 total=$2 msg=$3
  local width=40
  local percent=$(( current * 100 / total ))
  local filled=$(( percent * width / 100 ))
  local empty=$(( width - filled ))
  if [ "$INTERACTIVE" -eq 1 ]; then
    printf "\r$(color 3)[%3d%%]$(reset) %s %s%s" "$percent" "$msg" "$(printf '#%.0s' $(seq 1 $filled))" "$(printf '.%.0s' $(seq 1 $empty))"
    if [ "$current" -eq "$total" ]; then echo; fi
  else
    echo "[${percent}%] $msg"
  fi
}

# â”€â”€ Variables environnementales â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GIT_URL="${GIT_URL:-}"
GIT_REF="${GIT_REF:-main}"
PREFIX="${PREFIX:-/usr/local}"
FEATURES="${FEATURES:-}"
TARGETS="${TARGETS:-aarch64-apple-darwin}"
PROFILE="${PROFILE:-release}"

STEPS=7; step=0

# Ã‰tape 1 : PrÃ©requis
step=$((step+1)); progress "$step" "$STEPS" "VÃ©rification des dÃ©pendances..."
xcode-select -p >/dev/null 2>&1 || fail "Installe d'abord les Command Line Tools."
need git; need curl; sleep 0.3

# Ã‰tape 2 : Rustup
step=$((step+1)); progress "$step" "$STEPS" "Configuration de Rustup..."
if ! command -v rustup >/dev/null 2>&1; then
  log "Installation de rustup..."
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y >/dev/null
  export PATH="$HOME/.cargo/bin:$PATH"
else
  export PATH="$HOME/.cargo/bin:$PATH"
fi
rustup toolchain install stable -c rustfmt -c clippy >/dev/null 2>&1 || true
rustup default stable >/dev/null 2>&1 || true; sleep 0.2

# Ã‰tape 3 : Cibles Rust
step=$((step+1)); progress "$step" "$STEPS" "Ajout des cibles Rust ($TARGETS)..."
for t in $TARGETS; do rustup target add "$t" >/dev/null 2>&1 || true; done; sleep 0.2

# Ã‰tape 4 : Clone du dÃ©pÃ´t
step=$((step+1)); progress "$step" "$STEPS" "TÃ©lÃ©chargement du dÃ©pÃ´t..."
SRC_DIR="/usr/local/lib/vitte-src"
mkdir -p "$(dirname "$SRC_DIR")"
if [ -d "$SRC_DIR/.git" ]; then
  git -C "$SRC_DIR" fetch --all --tags >/dev/null 2>&1 || true
  git -C "$SRC_DIR" checkout "$GIT_REF" >/dev/null 2>&1 || true
  git -C "$SRC_DIR" pull >/dev/null 2>&1 || true
else
  git clone --depth 1 --branch "$GIT_REF" "$GIT_URL" "$SRC_DIR" >/dev/null 2>&1
fi; sleep 0.3

cd "$SRC_DIR"

# Ã‰tape 5 : Installation projet (install.sh / make install / cargo)
step=$((step+1)); progress "$step" "$STEPS" "Installation du projet..."
export PREFIX FEATURES TARGETS PROFILE
if [ -x "./scripts/install.sh" ]; then
  ./scripts/install.sh
elif [ -x "./install.sh" ]; then
  ./install.sh
elif grep -qE '(^|[^#])\binstall:' Makefile 2>/dev/null; then
  make install PREFIX="$PREFIX"
else
  for t in $TARGETS; do
    cargo build --release --target "$t" ${FEATURES:+--features "$FEATURES"} >/dev/null 2>&1
    OUT="target/$t/release"
    mkdir -p "$PREFIX/bin"
    find "$OUT" -maxdepth 1 -type f -perm -111 -print0 | xargs -0 -I{} install -m 0755 "{}" "$PREFIX/bin"
  done
fi; sleep 0.4

# Ã‰tape 6 : VÃ©rification finale
step=$((step+1)); progress "$step" "$STEPS" "VÃ©rification des binaires..."
ls "$PREFIX/bin" | grep vitte >/dev/null 2>&1 || fail "Aucun binaire Vitte trouvÃ©."; sleep 0.3

# Ã‰tape 7 : TerminÃ©
step=$((step+1)); progress "$step" "$STEPS" "Installation terminÃ©e âœ”"
log "Installation complÃ¨te dans $PREFIX/bin."
POST
chmod +x "$SCRIPTS/postinstall"

# â”€â”€ Construction du PKG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GIT_URL="$GIT_URL" GIT_REF="$GIT_REF" PREFIX="$PREFIX" FEATURES="$FEATURES" TARGETS="$TARGETS" PROFILE="$PROFILE" \
pkgbuild \
  --root "$PAYLOAD" \
  --identifier "$PKG_ID" \
  --version "$VERSION" \
  --install-location / \
  --scripts "$SCRIPTS" \
  "$PKG_OUT"

echo
echo "âœ… $(tput bold)PKG crÃ©Ã© :$(reset) $PKG_OUT"
echo "ðŸ“¡ Ce package clone le dÃ©pÃ´t et affiche une progression en temps rÃ©el dans le terminal."